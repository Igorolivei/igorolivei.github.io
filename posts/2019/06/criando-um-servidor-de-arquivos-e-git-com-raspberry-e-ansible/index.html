<!DOCTYPE html>
<html lang="pt">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
    content="Igor Oliveira ">
<meta name="description"
    content="Há muito tempo sou bem atraído pelo Raspberry PI. Um minicomputador com uma capacidade incrível (para seu tamanho), um preço razoável (até no Brasil), e uma infinidade de projetos que podem ter ele como base.
Tendo em mãos:
 Um Raspberry PI 3 Model B Um HD de 500GB um notebook antigo em um case para HD de notebook  E querendo estudar um pouco de Ansible, resolvi fazer um mini servidor de arquivos e git, sendo instalados usando Ansible." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://igorolivei.github.io/posts/2019/06/criando-um-servidor-de-arquivos-e-git-com-raspberry-e-ansible/" />


<title>
    
    Criando um servidor de arquivos e git com Raspberry e Ansible :: Igor Oliveira  — Tech and other stuff
    
</title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="https://igorolivei.github.io/main.min.d90905eb29b71569a516566cd9662312bee9ab021c760de6949cdc92d6688be9.css">



<link rel="apple-touch-icon" sizes="180x180" href="https://igorolivei.github.io/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://igorolivei.github.io/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://igorolivei.github.io/favicon-16x16.png">
<link rel="manifest" href="https://igorolivei.github.io/site.webmanifest">
<link rel="mask-icon" href="https://igorolivei.github.io/safari-pinned-tab.svg" color="#252627">
<link rel="shortcut icon" href="https://igorolivei.github.io/favicon.ico">
<meta name="theme-color" content="#252627">
<meta itemprop="name" content="Criando um servidor de arquivos e git com Raspberry e Ansible">
<meta itemprop="description" content="Há muito tempo sou bem atraído pelo Raspberry PI. Um minicomputador com uma capacidade incrível (para seu tamanho), um preço razoável (até no Brasil), e uma infinidade de projetos que podem ter ele como base.
Tendo em mãos:
 Um Raspberry PI 3 Model B Um HD de 500GB um notebook antigo em um case para HD de notebook  E querendo estudar um pouco de Ansible, resolvi fazer um mini servidor de arquivos e git, sendo instalados usando Ansible.">


<meta itemprop="datePublished" content="2019-06-08T10:52:14-03:00" />
<meta itemprop="dateModified" content="2019-06-08T10:52:14-03:00" />
<meta itemprop="wordCount" content="3021">



<meta itemprop="keywords" content="raspberry,ansible,git,gitea,owncloud," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://igorolivei.github.io"/>

<meta name="twitter:title" content="Criando um servidor de arquivos e git com Raspberry e Ansible"/>
<meta name="twitter:description" content="Há muito tempo sou bem atraído pelo Raspberry PI. Um minicomputador com uma capacidade incrível (para seu tamanho), um preço razoável (até no Brasil), e uma infinidade de projetos que podem ter ele como base.
Tendo em mãos:
 Um Raspberry PI 3 Model B Um HD de 500GB um notebook antigo em um case para HD de notebook  E querendo estudar um pouco de Ansible, resolvi fazer um mini servidor de arquivos e git, sendo instalados usando Ansible."/>




<meta property="article:published_time" content="2019-06-08 10:52:14 -0300 -03" />







    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://igorolivei.github.io/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">$ cd /home/igorolivei</span>
            <span class="logo__cursor"></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://igorolivei.github.io/about/">About</a></li><li><a href="https://igorolivei.github.io/posts/">Posts</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>

            

            </p>
        </div>

        <article>
            <h1 class="post-title"><a href="https://igorolivei.github.io/posts/2019/06/criando-um-servidor-de-arquivos-e-git-com-raspberry-e-ansible/">Criando um servidor de arquivos e git com Raspberry e Ansible</a></h1>

            

            <div class="post-content">
                

<p><img src="https://igorolivei.github.io/images/raspberry-stack.png" alt="Raspberry stack" /></p>

<p>Há muito tempo sou bem atraído pelo Raspberry PI. Um minicomputador com uma capacidade incrível (para seu tamanho), um preço razoável (até no Brasil), e uma infinidade de projetos que podem ter ele como base.</p>

<p>Tendo em mãos:</p>

<ul>
<li>Um <strong>Raspberry PI 3 Model B</strong></li>
<li>Um <strong>HD de 500GB</strong> um notebook antigo em um case para HD de notebook</li>
</ul>

<p><img src="https://igorolivei.github.io/images/raspberry-tools.jpg" alt="Raspberry tools" /></p>

<p>E querendo estudar um pouco de <strong>Ansible</strong>, resolvi fazer um mini servidor de arquivos e git, sendo instalados usando Ansible. Com isso consigo ter um pouco mais de segurança e privacidade nos dados, além de uma fonte de backup disponível mesmo sem internet (ao menos quando eu estiver em casa).</p>

<p>Escolhi para servidor de arquivos o <a href="https://owncloud.org" target="_blank">ownCloud</a>, e para o git o <a href="https://gitea.io" target="_blank">gitea</a>; simplesmente por serem soluções leves, gratuitas e open source.</p>

<h2 id="preparando-o-ambiente">Preparando o ambiente</h2>

<p>No Raspberry instalei o Raspbian Stretch Lite - distro baseada no Debian - na sua versão mais nova, que nada mais é que um Debian 9. As instruções para instalação podem ser encontradas na <a href="https://www.raspberrypi.org/documentation/installation/installing-images/README.md" target="_blank">documentação disponível no site do Raspberry</a>. Todos os playbooks foram pensados para funcionarem em distros baseadas no Debian.</p>

<p>Instale o Ansible 2.7+ (na sua máquina, no Raspberry não precisa ;D). Se estiver usando o Debian, Ubuntu, pode seguir <a href="https://linuxconfig.org/how-to-install-ansible-on-ubuntu-18-04-bionic-beaver-linux" target="_blank">esse tutorial</a> (a versão que tem nos repositórios padrão do Ubuntu é um pouco antiga, e vamos precisar de alguns recursos de versões mais novas). Caso esteja usando outra distro, tenho certeza que com uma rápida busca no Google você consegue encontrar como fazer.</p>

<p>O próximo passo é garantir nosso acesso via SSH ao Raspberry.</p>

<p>Primeiramente, acesse a tela de configuração do seu roteador, e descubra qual o IP do seu Raspberry (recomendo fortemente reservar um IP para ele, assim fica garantido que ao reiniciar o roteador, o IP se manterá o mesmo). Vou me referir a esse IP como <code>&lt;RASPBERRY_IP&gt;</code>.</p>

<p><img src="https://igorolivei.github.io/images/raspberry-reserved-ip.png" alt="Raspberry reserved IP" /></p>

<p>ATENÇÃO: Antes do uso, você provavelmente vai precisar habilitar o ssh no Raspberry usando o menu do <code>raspi-config</code>.</p>

<p>Depois de descobrir o IP do Raspberry, vamos copiar nossa chave ssh para ele (se ainda não tiver uma, crie utilizando o comando <code>ssh-keygen</code>):</p>

<p><code>ssh-copy-id -i ~/.ssh/&lt;SUA_CHAVE&gt;.pub pi@&lt;RASPBERRY_IP&gt;</code></p>

<p>Valide o acesso com o comando:</p>

<p><code>ssh pi@&lt;RASPBERRY_IP</code></p>

<p>O acesso não deve pedir senha.</p>

<p>Ok, já temos o acesso ao Raspberry, agora é hora de colocar a mão na massa! :)</p>

<p>Crie um diretório no seu lugar de preferência onde ficarão os playbooks, e em seguida entre nele:</p>

<p><code>mkdir rpi_ansible</code></p>

<p><code>cd rpi_ansible</code></p>

<p>Todos os playbooks e demais arquivos utilizador podem ser encontrados <a href="https://github.com/Igorolivei/rpi-server-ansible" target="_blank">nesse repositório</a>.</p>

<h2 id="preparando-o-raspberry">Preparando o raspberry</h2>

<p>Para começar as instalações, vamos criar nosso arquivo de inventário.</p>

<p><code>vi inventory.txt</code></p>

<p>Nele vamos definir o host onde vamos fazer nossas instalações e setar algumas variáveis que serão necessárias para os próximos playbooks. O conteúdo do meu arquivo ficou:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#66d9ef">[raspberry_pi:vars]</span>
<span style="color:#a6e22e">ansible_user</span><span style="color:#f92672">=</span><span style="color:#e6db74">pi</span>
<span style="color:#a6e22e">ansible_python_interpreter</span><span style="color:#f92672">=</span><span style="color:#e6db74">/usr/bin/python3</span>

<span style="color:#a6e22e">disk</span><span style="color:#f92672">=</span><span style="color:#e6db74">/dev/sda</span>
<span style="color:#a6e22e">owncloud_db_password</span><span style="color:#f92672">=</span><span style="color:#e6db74">0wnCl0ud</span>
<span style="color:#a6e22e">gitea_db_password</span><span style="color:#f92672">=</span><span style="color:#e6db74">g1te4</span>
<span style="color:#a6e22e">hostname</span><span style="color:#f92672">=</span><span style="color:#e6db74">192.168.15.18</span>

<span style="color:#66d9ef">[raspberry_pi]</span>
<span style="color:#a6e22e">192.168.15.18</span></code></pre></div>
<p>Para sua instalação, mude os valores para os que se adequarem ao seu caso:</p>

<ul>
<li>A variável <code>disk</code> deve receber o caminho do HD que você conectou, você pode descobrir isso executando um <code>lsblk</code> no Raspberry (aqui o HD apareceu como <code>sda</code>, então usarei <code>/dev/sda</code>).</li>
<li>As variáveis que terminam com <code>db_password</code> contém as senhas dos bancos do Gitea e do ownCloud. Se for instalar apenas um dos dois, pode remover a que é relacionada ao outro.</li>
<li>A variável <code>hostname</code> recebe o endereço do seu Raspberry. Pode ser o IP ou um hostname, caso este seja resolvido pela sua máquina (pode fazer o teste com um <code>ping &lt;HOSTNAME&gt;</code>).</li>
</ul>

<p>Se quiser validar o acesso do Ansible, pode criar um playbook para pegar algumas informações:</p>

<p><code>vi validate_conn.yml</code></p>

<p>Com o conteúdo:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- name: Validate connection
  hosts: raspberry-pi
  become: yes

  tasks:
  - name: Get host info
    debug:
      msg:
        - <span style="color:#e6db74">&#34;My hostname is {{ ansible_hostname }}&#34;</span>
        - <span style="color:#e6db74">&#34;My home is {{ ansible_env.HOME }}&#34;</span></code></pre></div>
<p>Execute com o comando <code>ansible-playbook validate_conn.yml -i inventory.txt</code> e a saída deve ser parecida com:</p>

<pre><code>PLAY [Validate connection] ****************************************************************************************************************************

TASK [Gathering Facts] ********************************************************************************************************************************
ok: [192.168.15.18]

TASK [Get hostname] ***********************************************************************************************************************************
ok: [192.168.15.18] =&gt; {
    &quot;msg&quot;: [
        &quot;My hostname is pi-server&quot;,
        &quot;My home is /root&quot;
    ]
}

PLAY RECAP ********************************************************************************************************************************************
192.168.15.18              : ok=2    changed=0    unreachable=0    failed=0
</code></pre>

<p>Bom, vamos criar o primeiro playbook. Este vai:</p>

<ul>
<li><strong>Formatar e montar o disco</strong> no caminho <code>/mnt/disk</code>;</li>
<li><strong>Atualizar todos os pacotes</strong> para a versão mais nova, rebootar o Raspberry e aguardar ele voltar para continuar (provavelmente o kernel também vai ser atualizado, e, confie em mim, o reboot vai evitar que vários problemas ocorram);</li>
<li>Instalar o <strong>NGINX</strong>, que utilizaremos para servir os dois serviços, e levar sua configuração;</li>
<li>Instalar o banco de dados <strong>MariaDB</strong> na versão 10.3 (anteriores a 10.2 geravam um bug no Gitea), o <strong>NTP</strong> (para garantir a data e hora no Raspberry);</li>
<li>Instalar o <strong>FirewallD</strong> e garantir que as portas 22, 80 e 443 estejam abertas;</li>
<li>Instalar o pacote <strong>net-tools</strong> (útil para verificar as portas usadas) e mais alguns outros pacotes que foram necessários para a instalação correta do repositório do MariaDB.</li>
</ul>

<p><code>vi prepare_machine.yml</code></p>

<p>Ele ficou com o seguinte conteúdo:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- name: Prepare machine
  hosts: raspberry_pi
  become: yes

  tasks:
  - name: Create mount dir
    file:
      path: /mnt/disk
      state: directory

  - name: Format volume
    filesystem:
      fstype: ext4
      dev: <span style="color:#e6db74">&#39;{{disk}}&#39;</span>

  - name: Create mountpoint
    mount:
      path: /mnt/disk
      src: <span style="color:#e6db74">&#39;{{disk}}&#39;</span>
      fstype: ext4
      state: mounted

  - name: Upgrade all packages to the latest version
    apt:
      name: <span style="color:#e6db74">&#39;*&#39;</span>
      state: latest
      update_cache: yes
      force_apt_get: <span style="color:#66d9ef">true</span>
    notify:
      - Reboot and wait to continue

  - meta: flush_handlers

  - name: Install packages
    apt:
      name: [dirmngr, apt-transport-https, net-tools, ntp, nginx, firewalld]
      state: present

  - name: Remove default nginx config
    file:
      dest: /etc/nginx/sites-enabled/default
      state: absent

  - name: Set timezone
    timezone:
      name: America/Sao_Paulo

  - name: Ensure NTP is running and enabled as configured.
    service:
      name: ntp
      state: started
      enabled: <span style="color:#66d9ef">true</span>

  - name: Add apt-key from MariaDB
    apt_key:
      keyserver: hkp://keyserver.ubuntu.com:<span style="color:#ae81ff">80</span>
      id: <span style="color:#e6db74">&#39;0xF1656F24C74CD1D8&#39;</span>
      state: present

  - name: Add MariaDB <span style="color:#ae81ff">10.3</span> repository
    apt_repository:
      repo: deb http://sfo1.mirrors.digitalocean.com/mariadb/repo/<span style="color:#ae81ff">10.3</span>/debian/ stretch main
      state: present
      update_cache: yes

  - name: Install MariaDB
    apt:
      name: mariadb-server
      state: present

  - name: Manage firewalld services
    firewalld:
      service: <span style="color:#e6db74">&#39;{{item}}&#39;</span>
      permanent: yes
      state: enabled
      immediate: yes
    with_items:
      - ssh
      - http
      - https

  handlers:
  - name: Reboot and wait to continue
    reboot:
      reboot_timeout: <span style="color:#ae81ff">180</span></code></pre></div>
<p>Agora que nosso playbook está pronto, basta executar:</p>

<p><code>ansible-playbook prepare-machine.yml -i inventory.txt</code></p>

<p>Obs.: Se preferir, pode pular as partes de execução, e executar todos os playbooks de uma vez, como eu ensino lá no final.</p>

<p>Você deve ver uma saída parecida com:</p>

<pre><code>
PLAY [Prepare machine] ********************************************************************************************************************************

TASK [Gathering Facts] ********************************************************************************************************************************
ok: [192.168.15.18]

TASK [Create mount dir] *******************************************************************************************************************************
changed: [192.168.15.18]

TASK [Format volume] **********************************************************************************************************************************
changed: [192.168.15.18]

TASK [Create mountpoint] ******************************************************************************************************************************
changed: [192.168.15.18]

TASK [Upgrade all packages to the latest version] *****************************************************************************************************
changed: [192.168.15.18]

RUNNING HANDLER [Reboot and wait to continue] *********************************************************************************************************
changed: [192.168.15.18]

TASK [Install packages] *******************************************************************************************************************************
changed: [192.168.15.18]

TASK [Remove default nginx config] ********************************************************************************************************************
changed: [192.168.15.18]

TASK [Set timezone] ***********************************************************************************************************************************
changed: [192.168.15.18]

TASK [Ensure NTP is running and enabled as configured.] ***********************************************************************************************
ok: [192.168.15.18]

TASK [Add apt-key from MariaDB] ***********************************************************************************************************************
changed: [192.168.15.18]

TASK [Add MariaDB 10.3 repository] ********************************************************************************************************************
changed: [192.168.15.18]

TASK [Install MariaDB] ********************************************************************************************************************************
changed: [192.168.15.18]

TASK [Manage firewalld services] **********************************************************************************************************************
ok: [192.168.15.18] =&gt; (item=ssh)
changed: [192.168.15.18] =&gt; (item=http)
changed: [192.168.15.18] =&gt; (item=https)

PLAY RECAP ********************************************************************************************************************************************
192.168.15.18              : ok=14   changed=12   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>

<h2 id="preparando-o-arquivo-de-configuração-do-nginx">Preparando o arquivo de configuração do nginx</h2>

<p>Eu sei que você já está ansioso para instalar as aplicações, mas antes vamos criar o arquivo de configuração do nginx, que será copiado pelos próximos playbooks (sim, ambos contém tasks de copiar, caso você queira usar só uma das aplicações):</p>

<p><code>vi nginx-config.j2</code></p>

<p>Com o conteúdo:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">server {
  listen <span style="color:#ae81ff">80</span>;

  server_name {{hostname}};

  root   /var/www;
  index  index.php index.html;

  <span style="color:#75715e">### Gitea block ###</span>
  location /gitea/ {
    proxy_pass http://localhost:<span style="color:#ae81ff">3000</span>/;
  }
  <span style="color:#75715e">### End Gitea block ###</span>

  <span style="color:#75715e">### ownCloud block ###</span>
  location /owncloud {
    <span style="color:#75715e"># set max upload size</span>
    client_max_body_size 512M;
    fastcgi_buffers <span style="color:#ae81ff">8</span> 4K;                     <span style="color:#75715e"># Please see note 1</span>
    fastcgi_ignore_headers X-Accel-Buffering; <span style="color:#75715e"># Please see note 2</span>

    <span style="color:#75715e"># Disable gzip to avoid the removal of the ETag header</span>
    <span style="color:#75715e"># Enabling gzip would also make your server vulnerable to BREACH</span>
    <span style="color:#75715e"># if no additional measures are done. See https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=773332</span>
    gzip off;

    <span style="color:#75715e"># Uncomment if your server is build with the ngx_pagespeed module</span>
    <span style="color:#75715e"># This module is currently not supported.</span>
    <span style="color:#75715e">#pagespeed off;</span>

    error_page <span style="color:#ae81ff">403</span> /owncloud/core/templates/<span style="color:#ae81ff">403.</span>php;
    error_page <span style="color:#ae81ff">404</span> /owncloud/core/templates/<span style="color:#ae81ff">404.</span>php;

    location /owncloud {
      rewrite ^ /owncloud/index.php$uri;
    }

    location ~ ^/owncloud/(?:build|tests|config|lib|3rdparty|templates|data)/ {
      return <span style="color:#ae81ff">404</span>;
    }
    location ~ ^/owncloud/(?:\.|autotest|occ|issue|indie|db_|console) {
      return <span style="color:#ae81ff">404</span>;
    }

    location ~ ^/owncloud/(?:index|remote|public|cron|core/ajax/update|status|ocs/v[<span style="color:#ae81ff">12</span>]|updater/.+|ocs-provider/.+|ocm-provider/.+|core/templates/<span style="color:#ae81ff">40</span>[<span style="color:#ae81ff">34</span>])\.php(?:$|/) {
      fastcgi_split_path_info ^(.+\.php)(/.<span style="color:#75715e">*)$;</span>
      include fastcgi_params;
      fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
      fastcgi_param SCRIPT_NAME $fastcgi_script_name; <span style="color:#75715e"># necessary for owncloud to detect the context root https://github.com/owncloud/core/blob/v10.0.0/lib/private/AppFramework/Http/Request.php#L603</span>
      fastcgi_param PATH_INFO $fastcgi_path_info;
      fastcgi_param modHeadersAvailable <span style="color:#66d9ef">true</span>; <span style="color:#75715e">#Avoid sending the security headers twice</span>
      <span style="color:#75715e"># EXPERIMENTAL: active the following if you need to get rid of the &#39;index.php&#39; in the URLs</span>
      <span style="color:#75715e">#fastcgi_param front_controller_active true;</span>
      fastcgi_read_timeout <span style="color:#ae81ff">180</span>; <span style="color:#75715e"># increase default timeout e.g. for long running carddav/ caldav syncs with 1000+ entries</span>
      fastcgi_pass unix:/run/php/php7.<span style="color:#ae81ff">0</span>-fpm.sock;
      fastcgi_intercept_errors on;
      fastcgi_request_buffering off; <span style="color:#75715e">#Available since NGINX 1.7.11</span>
    }

    location ~ ^/owncloud/(?:updater|ocs-provider|ocm-provider)(?:$|/) {
      try_files $uri $uri/ =<span style="color:#ae81ff">404</span>;
      index index.php;
    }

    <span style="color:#75715e"># Adding the cache control header for js and css files</span>
    <span style="color:#75715e"># Make sure it is BELOW the PHP block</span>
    location ~ /owncloud/.<span style="color:#75715e">*\.(?:css|js)</span> {
      try_files $uri /owncloud/index.php$uri$is_args$args;
      add_header Cache-Control <span style="color:#e6db74">&#34;max-age=15778463&#34;</span> always;

      <span style="color:#75715e"># Add headers to serve security related headers (It is intended to have those duplicated to the ones above)</span>
      <span style="color:#75715e"># The always parameter ensures that the header is set for all responses, including internally generated error responses.</span>
      <span style="color:#75715e"># Before enabling Strict-Transport-Security headers please read into this topic first.</span>
      <span style="color:#75715e"># https://www.nginx.com/blog/http-strict-transport-security-hsts-and-nginx/</span>

      <span style="color:#75715e">#add_header Strict-Transport-Security &#34;max-age=15552000; includeSubDomains; preload&#34; always;</span>
      add_header X-Content-Type-Options nosniff always;
      add_header X-Frame-Options <span style="color:#e6db74">&#34;SAMEORIGIN&#34;</span> always;
      add_header X-XSS-Protection <span style="color:#e6db74">&#34;1; mode=block&#34;</span> always;
      add_header X-Robots-Tag none always;
      add_header X-Download-Options noopen always;
      add_header X-Permitted-Cross-Domain-Policies none always;
      <span style="color:#75715e"># Optional: Don&#39;t log access to assets</span>
      access_log off;
    }

    location ~ /owncloud/.<span style="color:#75715e">*\.(?:svg|gif|png|html|ttf|woff|ico|jpg|jpeg|map|json)</span> {
      try_files $uri /owncloud/index.php$uri$is_args$args;
      add_header Cache-Control <span style="color:#e6db74">&#34;public, max-age=7200&#34;</span> always;
      <span style="color:#75715e"># Optional: Don&#39;t log access to other assets</span>
      access_log off;
    }
  }
  <span style="color:#75715e">### End ownCloud block ###</span>
}</code></pre></div>
<p>Caso deseje instalar apenas uma das aplicações, pode remover o bloco da outra do arquivo do nginx. Deixei comentado para facilitar a identificação de qual é qual.</p>

<p>Essas configurações foram baseadas nas próprias documentações do <a href="https://docs.gitea.io/pt-br/reverse-proxies/" target="_blank">Gitea</a> e do <a href="https://doc.owncloud.org/server/10.1/admin_manual/installation/nginx_configuration.html" target="_blank">ownCloud</a>.</p>

<ul>
<li>O ownCloud vai poder ser acessado no endereço: <code>http://&lt;RASPBERRY_IP&gt;/owncloud</code></li>
<li>O Gitea vai poder ser acessado no endereço: <code>http://&lt;RASPBERRY_IP&gt;/gitea</code></li>
</ul>

<h2 id="instalando-o-owncloud">Instalando o ownCloud</h2>

<p>Para a instalação do ownCloud, me baseei <a href="https://fuga.cloud/academy/tutorials/deploy-owncloud-with-ansible/" target="_blank">nesse post</a>.</p>

<p>Vamos criar nosso playbook:</p>

<p><code>vi install_owncloud.yml</code></p>

<p>Com o seguinte conteúdo:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- name: Install ownCloud
  hosts: raspberry_pi
  become: yes

  tasks:
  - name: Create ownCloud dir
    file:
      path: /var/www/owncloud
      state: directory

  - name: Create data dir on disk
    file:
      path: /mnt/disk/owncloud_data
      state: directory
      owner: www-data
      group: www-data

  - name: Create symlink to data dir on mounted disk
    file:
      src: /mnt/disk/owncloud_data
      dest: /var/www/owncloud/data
      state: link
      owner: www-data
      group: www-data

  - name: Install required packages for ownCloud
    apt:
      name: [openssl, php-imagick, php7.<span style="color:#ae81ff">0</span>-common, php7.<span style="color:#ae81ff">0</span>-cgi, php7.<span style="color:#ae81ff">0</span>-curl, php7.<span style="color:#ae81ff">0</span>-fpm, php7.<span style="color:#ae81ff">0</span>-gd, php7.<span style="color:#ae81ff">0</span>-imap, php7.<span style="color:#ae81ff">0</span>-intl, php7.<span style="color:#ae81ff">0</span>-json, php7.<span style="color:#ae81ff">0</span>-ldap, php7.<span style="color:#ae81ff">0</span>-mbstring, php7.<span style="color:#ae81ff">0</span>-mcrypt, php7.<span style="color:#ae81ff">0</span>-mysql, php7.<span style="color:#ae81ff">0</span>-pgsql, php-smbclient, php-ssh2, php7.<span style="color:#ae81ff">0</span>-sqlite3, php7.<span style="color:#ae81ff">0</span>-xml, php7.<span style="color:#ae81ff">0</span>-zip, python3-mysqldb, python3-dev]
      state: present

  - name: Add apt-key from ownCloud
    apt_key:
      url: https://download.owncloud.org/download/repositories/<span style="color:#ae81ff">10.2</span>.<span style="color:#ae81ff">0</span>/Debian_9.<span style="color:#ae81ff">0</span>/Release.key
      state: present

  - name: Add ownCloud repository
    apt_repository:
      repo: deb https://download.owncloud.org/download/repositories/<span style="color:#ae81ff">10.2</span>.<span style="color:#ae81ff">0</span>/Debian_9.<span style="color:#ae81ff">0</span>/ /
      state: present
      update_cache: yes

  - name: Install / Download ownCloud
    apt:
      name: owncloud-files

  - name: Create <span style="color:#e6db74">&#39;owncloud&#39;</span> Database
    mysql_db:
      name: owncloud
      state: present
    notify:
      - Change password of owncloud database user

  - name: Copy owncloud nginx config
    template:
      src: nginx-conf.j2
      dest: /etc/nginx/conf.d/rpi-server
    notify:
      - Enable nginx config
      - Restart nginx

  handlers:
  - name: Change password of owncloud database user
    command: <span style="color:#e6db74">&gt;
</span><span style="color:#e6db74">      mysql -u root --execute=&#34;GRANT ALL ON owncloud.* to &#39;owncloud&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;{{owncloud_db_password}}&#39;; FLUSH PRIVILEGES;&#34;</span>

  - name: Enable nginx config
    file:
      src: /etc/nginx/conf.d/rpi-server
      dest: /etc/nginx/sites-enabled/rpi-server
      state: link
      owner: www-data
      group: www-data

  - name: Restart nginx
    systemd:
      name: nginx
      state: reloaded</code></pre></div>
<p>Esse playbook cria os diretórios, instala pacotes e o owncloud, garante que a configuração do nginx esteja lá, e este seja reiniciado.</p>

<p>Execute a instalação com:</p>

<p><code>ansible-playbook install_owncloud.yml -i inventory.txt</code></p>

<p>Você deverá ver uma saída parecida com:</p>

<pre><code>PLAY [Install ownCloud] *******************************************************************************************************************************

TASK [Gathering Facts] ********************************************************************************************************************************
ok: [192.168.15.18]

TASK [Create ownCloud dir] ****************************************************************************************************************************
changed: [192.168.15.18]

TASK [Create data dir on disk] ************************************************************************************************************************
changed: [192.168.15.18]

TASK [Create symlink to data dir on mounted disk] *****************************************************************************************************
changed: [192.168.15.18]

TASK [Install required packages for ownCloud] *********************************************************************************************************
changed: [192.168.15.18]

TASK [Add apt-key from ownCloud] **********************************************************************************************************************
changed: [192.168.15.18]

TASK [Add ownCloud repository] ************************************************************************************************************************
changed: [192.168.15.18]

TASK [Install / Download ownCloud] ********************************************************************************************************************
changed: [192.168.15.18]

TASK [Create 'owncloud' Database] *********************************************************************************************************************
changed: [192.168.15.18]

TASK [Copy owncloud nginx config] *********************************************************************************************************************
changed: [192.168.15.18]

RUNNING HANDLER [Change password of owncloud database user] *******************************************************************************************
changed: [192.168.15.18]

RUNNING HANDLER [Enable nginx config] *****************************************************************************************************************
changed: [192.168.15.18]

RUNNING HANDLER [Restart nginx] ***********************************************************************************************************************
changed: [192.168.15.18]

PLAY RECAP ********************************************************************************************************************************************
192.168.15.18              : ok=13   changed=12   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>

<h3 id="concluindo-a-instalação-do-owncloud">Concluindo a instalação do OwnCloud</h3>

<p>Após instalar, abra seu navegador e acesse <code>http://&lt;RASPBERRY_IP&gt;/owncloud</code>. Estamos nos últimos passos da configuração do ownCloud. Vamos preencher os campos:</p>

<ul>
<li>Defina um usuário administrador e sua senha</li>
<li>Logo abaixo, em &ldquo;Armazenamento e Banco de Dados&rdquo;, selecione <code>MySQL/MariaDB</code> e preencha os dados necessários:

<ul>
<li>Usuário: <code>owncloud</code></li>
<li>Senha: A que você definiu para o banco do ownCloud (no inventory.txt que coloquei acima era <code>0wnCl0ud</code>)</li>
<li>Database: <code>owncloud</code></li>
<li>Clique em <code>Concluir configuração</code> e pronto!</li>
</ul></li>
</ul>

<p>Seu servidor de arquivos está pronto para uso! :)</p>

<h2 id="instalando-o-gitea">Instalando o Gitea</h2>

<p>Para a instalação do Gitea, me baseei <a href="https://www.vultr.com/docs/how-to-install-gitea-on-debian-9" target="_blank">nesse tutorial de instalação</a>.</p>

<p>Para começar, vamos criar o template do arquivo de serviço do Gitea (relaxa, o Ansible lida com o resto):</p>

<p><code>vi gitea-service.j2</code></p>

<p>Com o conteúdo:</p>

<pre><code>[Unit]
Description=Gitea (Git with a cup of tea)
After=syslog.target
After=network.target
After=mariadb.service

[Service]
# Modify these two values and uncomment them if you have
# repos with lots of files and get an HTTP error 500 because
# of that
###
#LimitMEMLOCK=infinity
#LimitNOFILE=65535
RestartSec=2s
Type=simple
User=gitea
Group=gitea
WorkingDirectory=/var/lib/gitea/
ExecStart=/usr/local/bin/gitea web -c /etc/gitea/app.ini
Restart=always
Environment=USER=gitea HOME=/home/gitea GITEA_WORK_DIR=/var/lib/gitea
# If you want to bind Gitea to a port below 1024 uncomment
# the two values below
###
#CapabilityBoundingSet=CAP_NET_BIND_SERVICE
#AmbientCapabilities=CAP_NET_BIND_SERVICE

[Install]
WantedBy=multi-user.target
</code></pre>

<p>Agora vamos ao playbook:</p>

<p><code>vi install_gitea.yml</code></p>

<p>O conteúdo do playbook ficou:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- name: Install gitea
  hosts: raspberry_pi
  become: yes

  tasks:
  - name: create gitea group
    group:
      name: gitea
      state: present

  - name: create gitea user
    user:
      name: gitea
      group: gitea
      home: /home/gitea
      comment: Gitea
      system: yes
      shell: /bin/bash

  - name: Create gitea dir on disk
    file:
      path: <span style="color:#e6db74">&#39;{{ item }}&#39;</span>
      state: directory
      owner: gitea
      group: gitea
      mode: <span style="color:#ae81ff">0750</span>
    with_items:
      - /mnt/disk/gitea_repositories
      - /mnt/disk/gitea_lfs

  - name: Create gitea etc dir
    file:
      path: /etc/gitea
      state: directory
      owner: root
      group: gitea
      mode: <span style="color:#ae81ff">0770</span>

  - name: Create gitea directories
    file:
      path: <span style="color:#e6db74">&#39;{{ item }}&#39;</span>
      state: directory
      owner: gitea
      group: gitea
    with_items:
      - /var/lib/gitea/custom
      - /var/lib/gitea/public

  - name: Create gitea <span style="color:#ae81ff">0750</span> directories
    file:
      path: <span style="color:#e6db74">&#39;{{ item }}&#39;</span>
      state: directory
      owner: gitea
      group: gitea
      mode: <span style="color:#ae81ff">0750</span>
    with_items:
      - /var/lib/gitea/indexers
      - /var/lib/gitea/log
      - /var/lib/gitea/data

  - name: Create symlink of repositories to data dir on mounted disk
    file:
      src: /mnt/disk/gitea_repositories
      dest: /var/lib/gitea/data/repositories
      state: link
      owner: gitea
      group: gitea

  - name: Create symlink of lfs to data dir on mounted disk
    file:
      src: /mnt/disk/gitea_lfs
      dest: /var/lib/gitea/data/lfs
      state: link
      owner: gitea
      group: gitea

  - name: Install git
    apt:
      name: git
      state: present

  - name: Create <span style="color:#e6db74">&#39;gitea&#39;</span> Database
    mysql_db:
      name: gitea
      state: present
    notify:
      - Change password of gitea database user

  - name: Download gitea binary
    get_url:
      url: https://dl.gitea.io/gitea/<span style="color:#ae81ff">1.7</span>.<span style="color:#ae81ff">6</span>/gitea-<span style="color:#ae81ff">1.7</span>.<span style="color:#ae81ff">6</span>-linux-arm-<span style="color:#ae81ff">7</span>
      dest: /usr/local/bin/gitea
      owner: gitea
      group: gitea
      mode: <span style="color:#ae81ff">0755</span>

  - name: Copy gitea service file
    template:
      src: gitea-service.j2
      dest: /etc/systemd/system/gitea.service
    notify:
      - Start service gitea
      - Add first lines to app.ini

  - name: Copy gitea nginx config
    template:
      src: nginx-conf.j2
      dest: /etc/nginx/conf.d/rpi-server
    notify:
      - Enable nginx config
      - Restart nginx

  handlers:
  - name: Change password of gitea database user
    command: <span style="color:#e6db74">&gt;
</span><span style="color:#e6db74">      mysql -u root --execute=&#34;GRANT ALL ON gitea.* TO &#39;gitea&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;{{gitea_db_password}}&#39; WITH GRANT OPTION; FLUSH PRIVILEGES;&#34;</span>

  - name: Start service gitea
    systemd:
      name: gitea
      state: restarted
      daemon_reload: yes
      enabled: yes

  - name: Add first lines to app.ini
    lineinfile:
      path: /etc/gitea/app.ini
      line: <span style="color:#e6db74">&#39;{{item}}&#39;</span>
    with_items:
      - <span style="color:#e6db74">&#39;[server]&#39;</span>
      - <span style="color:#e6db74">&#39;ROOT_URL=http://{{hostname}}/gitea/&#39;</span>
      - <span style="color:#e6db74">&#39;LFS_CONTENT_PATH=/var/lib/gitea/data/lfs&#39;</span>
      - <span style="color:#e6db74">&#39;[repository]&#39;</span>
      - <span style="color:#e6db74">&#39;ROOT=/var/lib/gitea/data/repositories&#39;</span>
    notify:
      - Start service gitea

  - name: Enable nginx config
    file:
      src: /etc/nginx/conf.d/rpi-server
      dest: /etc/nginx/sites-enabled/rpi-server
      state: link
      owner: www-data
      group: www-data

  - name: Restart nginx
    systemd:
      name: nginx
      state: reloaded</code></pre></div>
<p>Execute com o comando:</p>

<p><code>ansible-playbook install-gitea.yml -i inventory.yml</code></p>

<p>E a saída deve ser algo parecido com:</p>

<pre><code>PLAY [Install gitea] **********************************************************************************************************************************

TASK [Gathering Facts] ********************************************************************************************************************************
ok: [192.168.15.18]

TASK [create gitea group] *****************************************************************************************************************************
changed: [192.168.15.18]

TASK [create gitea user] ******************************************************************************************************************************
changed: [192.168.15.18]

TASK [Create gitea dir on disk] ***********************************************************************************************************************
changed: [192.168.15.18] =&gt; (item=/mnt/disk/gitea_repositories)
changed: [192.168.15.18] =&gt; (item=/mnt/disk/gitea_lfs)

TASK [Create gitea etc dir] ***************************************************************************************************************************
changed: [192.168.15.18]

TASK [Create gitea directories] ***********************************************************************************************************************
changed: [192.168.15.18] =&gt; (item=/var/lib/gitea/custom)
changed: [192.168.15.18] =&gt; (item=/var/lib/gitea/public)

TASK [Create gitea 0750 directories] ******************************************************************************************************************
changed: [192.168.15.18] =&gt; (item=/var/lib/gitea/indexers)
changed: [192.168.15.18] =&gt; (item=/var/lib/gitea/log)
changed: [192.168.15.18] =&gt; (item=/var/lib/gitea/data)

TASK [Create symlink of repositories to data dir on mounted disk] *************************************************************************************
changed: [192.168.15.18]

TASK [Create symlink of lfs to data dir on mounted disk] **********************************************************************************************
changed: [192.168.15.18]

TASK [Install git] ************************************************************************************************************************************
changed: [192.168.15.18]

TASK [Create 'gitea' Database] ************************************************************************************************************************
changed: [192.168.15.18]

TASK [Download gitea binary] **************************************************************************************************************************
changed: [192.168.15.18]

TASK [Copy gitea service file] ************************************************************************************************************************
changed: [192.168.15.18]

TASK [Copy gitea nginx config] ************************************************************************************************************************
ok: [192.168.15.18]

RUNNING HANDLER [Change password of gitea database user] **********************************************************************************************
changed: [192.168.15.18]

RUNNING HANDLER [Start service gitea] *****************************************************************************************************************
changed: [192.168.15.18]

RUNNING HANDLER [Add first lines to app.ini] **********************************************************************************************************
changed: [192.168.15.18] =&gt; (item=[server])
changed: [192.168.15.18] =&gt; (item=ROOT_URL=http://192.168.15.18/gitea/)
changed: [192.168.15.18] =&gt; (item=LFS_CONTENT_PATH=/var/lib/gitea/data/lfs)
changed: [192.168.15.18] =&gt; (item=[repository])
changed: [192.168.15.18] =&gt; (item=ROOT=/var/lib/gitea/data/repositories)

RUNNING HANDLER [Start service gitea] *****************************************************************************************************************
changed: [192.168.15.18]

PLAY RECAP ********************************************************************************************************************************************
192.168.15.18              : ok=18   changed=16   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>

<h3 id="concluindo-a-instalação-do-gitea">Concluindo a instalação do Gitea</h3>

<p>Para concluir a instalação, acesse <code>http://&lt;RASPBERRY_IP&gt;/gitea/install</code>, e preencha os campos necessários:</p>

<ul>
<li>Configure a conexão ao banco:

<ul>
<li>Senha: A senha definida no inventory.txt (no exemplo dado, utilizei <code>g1te4</code>)</li>
</ul></li>
<li>Opcionalmente crie uma conta de administrador; do contrário, a conta utilizada de administrador será a primeira conta que for criada</li>
<li>Clique em &ldquo;Instalar Gitea&rdquo;, e pronto!</li>
</ul>

<p>Servidor git pronto para uso! :)</p>

<h2 id="executando-todos-os-playbooks-de-uma-vez">Executando todos os playbooks de uma vez</h2>

<p>Se preferir, pode criar todos os arquivos e playbooks, e executar com <code>ansible-playbook prepare-machine.yml install_owncloud.yml install_gitea.yml -i inventory.txt</code>.</p>

<h2 id="resultado">Resultado</h2>

<p>Aqui está meu projetinho pronto (sim, eu sei que preciso de um case pro Raspberry, e eu sei que é meio irônico usar uma caixa de Orange PI como case temporário [O Orange PI vai ser outro projeto]):</p>

<p><img src="https://igorolivei.github.io/images/raspberry-done.jpg" alt="Raspberry done" /></p>

<p>Só lembrando que tudo foi pensado para um uso pessoal, e o Raspberry de maneira nenhuma vai servir como um servidor de produção.</p>

<p>Lembrando também que agradeço qualquer dica ou sugestão, principalmente relacionadas aos playbooks, já que estes foram os meus primeiros.</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://igorolivei.github.io/tags/raspberry">raspberry</a></span><span class="tag"><a href="https://igorolivei.github.io/tags/ansible">ansible</a></span><span class="tag"><a href="https://igorolivei.github.io/tags/git">git</a></span><span class="tag"><a href="https://igorolivei.github.io/tags/gitea">gitea</a></span><span class="tag"><a href="https://igorolivei.github.io/tags/owncloud">owncloud</a></span>
                </p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2019-06-08 10:52 -0300</p>
        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h"></span>
                    <hr />
                </div>

                <div class="pagination__buttons">
                    
                        <span class="button previous">
                            <a href="https://igorolivei.github.io/posts/2019/05/da-zona-de-conforto-ao-aprendizado-cont%C3%ADnuo/">
                                <span class="button__icon">←</span>
                                <span class="button__text">Da zona de conforto ao aprendizado contínuo</span>
                            </a>
                        </span>
                    

                    
                </div>
            </div>
        

        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2019</span>
            
                <span><a href="https://igorolivei.github.io">Igor Oliveira</a></span>
            
            <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span>
            <span> <a href="https://igorolivei.github.io/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">

        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">rhazdon</a></span>
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="https://igorolivei.github.io/bundle.min.9e52e68b082cf2a30a7fead88260edb8818fbd7f7831e39674917d4539ec75df41ba88eaddfbd916594ab4fb2a31913b46cf2d6094cf80381edb8c632512a8ca.js" integrity="sha512-nlLmiwgs8qMKf&#43;rYgmDtuIGPvX94MeOWdJF9RTnsdd9Buojq3fvZFllKtPsqMZE7Rs8tYJTPgDge24xjJRKoyg=="></script>



    </body>
</html>
